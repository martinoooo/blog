## 1. TCP

### 三次连接

1. 客户端发送请求报文，报文中携带SYN=1，seq=x，客户端进入 同步已发送状态（SYN-SENT）
2. 服务端收到报文之后，返回确认报文，携带SYN=1，ACK=1，seq=y，ack=x+1，服务端进入 同步收到（SYN-RCVD）状态
3. 客户端收到确认报文之后，还要返回确认报文，携带SYN=1，ACK=1，ack=y+1，seq=x+1，客户端进入 已建立连接（ESTABLISHED） 状态
4. 服务端收到确认报文之后，也进入 已建立连接状态（ESTABLISHED），之后双方进行通信

### 四次挥手

1. 客户端发送连接释放报文，并且停止发送数据。携带FIN=1，seq=u（等于等于前面已经传送过来的数据的最后一个字节的序号加1），客户端进入 终止等待1（FIN-WAIT-1）状态。
2. 服务端收到释放报文之后，发布确认报文。携带ACK=1，ack=u+1，seq=v，服务端进入 关闭等待（CLOSE-WAIT）状态
3. 客户端收到确认报文之后，进入 终止等待2（FIN-WAIT-2）状态，等待服务器发送释放连接的报文。
4. 服务器将最后的数据发送完毕之后，发送释放报文，携带FIN=1，ack=u+1，seq=w，服务器进入 最后确认（LAST-ACK）状态
5. 客户端收到释放报文之后，发送确认报文，携带ACK=1，ack=w+1，seq=u+1，进入 时间等待（TIME-WAIT）状态。注意此时TCP接还没有释放，必须经过2*MSL（最长报文段寿命）的时间后，当客户端撤销相应的TCB后，才进入CLOSED状态。
6. 服务端收到确认报文之后，进入 CLOSED 状态。可以看到服务器结束TCP连接的时间比客户端要早。

### 为什么客户端最后还要等待2MSL？

MSL（Maximum Segment Lifetime），TCP允许不同的实现可以设置不同的MSL值。

第一，保证客户端发送的最后一个ACK报文能够到达服务器，因为这个ACK报文可能丢失，站在服务器的角度看来，我已经发送了FIN+ACK报文请求断开了，客户端还没有给我回应，应该是我发送的请求断开报文它没有收到，于是服务器又会重新发送一次，而客户端就能在这个2MSL时间段内收到这个重传的报文，接着给出回应报文，并且会重启2MSL计时器。

第二，防止类似与“三次握手”中提到了的“已经失效的连接请求报文段”出现在本连接中。客户端发送完最后一个确认报文后，在这个2MSL时间中，就可以使本连接持续的时间内所产生的所有报文段都从网络中消失。这样新的连接中不会出现旧连接的请求报文。

### 如果已经建立了连接，但是客户端突然出现故障了怎么办？

TCP还设有一个保活计时器，显然，客户端如果出现故障，服务器不能一直等下去，白白浪费资源。服务器每收到一次客户端的请求后都会重新复位这个计时器，时间通常是设置为2小时，若两小时还没有收到客户端的任何数据，服务器就会发送一个探测报文段，以后每隔75秒发送一次。若一连发送10个探测报文仍然没反应，服务器就认为客户端出了故障，接着就关闭连接。

### TCP第三次握手失败后怎么办

当客户端收到服务端的SYN+ACK应答后，其状态变为ESTABLISHED，并会发送ACK包给服务端，准备发送数据了。如果此时ACK在网络中丢失，过了超时计时器后，那么Server端会重新发送SYN+ACK包，重传次数根据/proc/sys/net/ipv4/tcp_synack_retries来指定，默认是5次。如果重传指定次数到了后，仍然未收到ACK应答，那么一段时间后，Server自动关闭这个连接。但是Client认为这个连接已经建立，如果Client端向Server写数据，Server端将以RST包响应，方能感知到Server的错误。

可以看出当失败时服务器并不会重传ack报文，而是直接发送RST报文段，进入CLOSED状态。这样做的目的是为了防止SYN洪泛攻击。

### SYN泛洪攻击

TCP SYN泛洪发生在OSI第四层，这种方式利用TCP协议的特性，就是三次握手。攻击者发送TCP SYN，SYN是TCP三次握手中的第一个数据包，而当服务器返回ACK后，该攻击者就不对其进行再确认，那这个TCP连接就处于挂起状态，也就是所谓的半连接状态，服务器收不到再确认的话，还会重复发送ACK给攻击者。这样更加会浪费服务器的资源。攻击者就对服务器发送非常大量的这种TCP连接，由于每一个都没法完成三次握手，所以在服务器上，这些TCP连接会因为挂起状态而消耗CPU和内存，最后服务器可能死机，就无法为正常用户提供服务了。

#### 防范：

如降低SYN timeout时间，使得主机尽快释放半连接的占用；又比如采用SYN cookie设置，如果短时间内连续收到某个IP的重复SYN请求，则认为受到了该IP的攻击，丢弃来自该IP的后续请求报文。此外合理地采用防火墙等外部网络安全设施也可缓解SYN泛洪攻击。